{"version":3,"file":"ticket-detail.js","sources":["pages/ECommerce/pages/ticket-detail.vue","pages/ECommerce/pages/ticket-detail.vue?type=page"],"sourcesContent":["<template>\n\t<custom-navigation-bar :back=\"true\" />\n\n\t<view class=\"content\">\n\t\t<!-- 票务封面 -->\n\t\t<view class=\"ticket-poster\" v-if=\"ticketDetail.posterUrl\">\n\t\t\t<image :src=\"ticketDetail.posterUrl\" class=\"poster-image\" mode=\"widthFix\"></image>\n\t\t</view>\n\t\t\n\t\t<!-- 票务信息 -->\n\t\t<view class=\"ticket-info-section\">\n\t\t\t<text class=\"ticket-name\" v-if=\"ticketDetail.name\">{{ ticketDetail.name }}</text>\n\t\t\t\n\t\t\t<!-- 价格信息 -->\n\t\t\t<view class=\"price-section\">\n\t\t\t\t<!-- 有原价且与现价不同时显示原价 -->\n\t\t\t\t<text class=\"original-price\" \n\t\t\t\t\t  v-if=\"ticketDetail.originalPrice && ticketDetail.originalPrice !== ticketDetail.currentPrice\">\n\t\t\t\t\t¥{{ formatPrice(ticketDetail.originalPrice) }}\n\t\t\t\t</text>\n\t\t\t\t<!-- 现价 -->\n\t\t\t\t<text class=\"current-price\">\n\t\t\t\t\t¥{{ formatPrice(ticketDetail.currentPrice) }}\n\t\t\t\t</text>\n\t\t\t</view>\n\t\t\t\n\t\t\t<!-- 详细描述 -->\n\t\t\t<view class=\"description-section\" v-if=\"ticketDetail.details\">\n\t\t\t\t<text class=\"section-title\">详细描述</text>\n\t\t\t\t<text class=\"description-text\">{{ ticketDetail.details }}</text>\n\t\t\t</view>\n\t\t</view>\n\t\t\n\t\t<!-- 底部操作栏 -->\n\t\t<view class=\"bottom-action-bar\">\n\t\t\t<!-- 数量选择 -->\n\t\t\t<view class=\"quantity-section\">\n\t\t\t\t<text class=\"quantity-label\">数量</text>\n\t\t\t\t<view class=\"quantity-control\">\n\t\t\t\t\t<view class=\"quantity-btn\" @click=\"decreaseQuantity\">\n\t\t\t\t\t\t<text class=\"btn-text\">-</text>\n\t\t\t\t\t</view>\n\t\t\t\t\t<text class=\"quantity-text\">{{ quantity }}</text>\n\t\t\t\t\t<view class=\"quantity-btn\" @click=\"increaseQuantity\">\n\t\t\t\t\t\t<text class=\"btn-text\">+</text>\n\t\t\t\t\t</view>\n\t\t\t\t</view>\n\t\t\t</view>\n\t\t\t\n\t\t\t<!-- 购买按钮 -->\n\t\t\t<user-check :item=\"['login', 'phone']\">\n\t\t\t\t<view class=\"buy-section\">\n\t\t\t\t\t<view class=\"total-price\">\n\t\t\t\t\t\t<text class=\"price-label\">合计</text>\n\t\t\t\t\t\t<text class=\"price-value\">¥{{ totalPrice }}</text>\n\t\t\t\t\t</view>\n\t\t\t\t\t<view class=\"buy-button\" :class=\"{ 'loading': isPurchasing }\" @click=\"purchaseTicket\">\n\t\t\t\t\t\t<text class=\"buy-text\" v-if=\"!isPurchasing\">立即购买</text>\n\t\t\t\t\t\t<text class=\"buy-text\" v-else>购买中...</text>\n\t\t\t\t\t</view>\n\t\t\t\t</view>\n\t\t\t</user-check>\n\t\t</view>\n\t\t\n\t\t<!-- 全屏loading遮罩 -->\n\t\t<view class=\"loading-overlay\" v-if=\"isLoading\">\n\t\t\t<view class=\"loading-content\">\n\t\t\t\t<view class=\"loading-spinner\"></view>\n\t\t\t\t<text class=\"loading-text\">购买中...</text>\n\t\t\t</view>\n\t\t</view>\n\t</view>\n</template>\n\n<script setup>\nimport { onLoad } from '@dcloudio/uni-app'\nimport { ref, computed, watch } from 'vue'\nimport Decimal from 'decimal.js'\nimport { ticket as ticketAPI, order as orderAPI } from '@/api'\nimport { getFromSalesId } from '@/common/storage'\n\n// 票务详情数据\nconst ticketDetail = ref({})\nconst quantity = ref(1)\nconst totalPrice = ref(0)\nconst isPurchasing = ref(false) // 购票loading状态\nconst isLoading = ref(false) // 全屏loading状态\n\n// 监听数量变化\nwatch([quantity], () => {\n\t// 当数量变化时，重新计算价格\n\tcalculatePrice()\n})\n\nonLoad((options) => {\n\tconst { id } = options\n\tif (id) {\n\t\tgetTicketDetail(id)\n\t}\n})\n\n// 获取票务详情\nconst getTicketDetail = async (id) => {\n\ttry {\n\t\tconst res = await ticketAPI.find(id)\n\t\tticketDetail.value = res\n\t\tcalculatePrice()\n\t} catch (error) {\n\t\tconsole.error('获取票务详情失败:', error)\n\t\tuni.showToast({\n\t\t\ttitle: '获取票务详情失败',\n\t\t\ticon: 'none'\n\t\t})\n\t\tsetTimeout(() => {\n\t\t\tuni.navigateBack()\n\t\t}, 1500)\n\t}\n}\n\n// 格式化价格（分转元）\nconst formatPrice = (price) => {\n\tif (!price) return '0'\n\treturn new Decimal(price).div(100).toNumber()\n}\n\n// 增加数量\nconst increaseQuantity = () => {\n\tquantity.value++\n}\n\n// 减少数量\nconst decreaseQuantity = () => {\n\tif (quantity.value > 1) {\n\t\tquantity.value--\n\t}\n}\n\n// 计算价格\nconst calculatePrice = () => {\n\tif (!ticketDetail.value.currentPrice) {\n\t\ttotalPrice.value = 0\n\t\treturn\n\t}\n\t\n\tconst price = new Decimal(ticketDetail.value.currentPrice).div(100)\n\tconst calculatedPrice = price.mul(quantity.value).toNumber()\n\ttotalPrice.value = calculatedPrice\n}\n\n// 购买票务（复用theme.vue的购买逻辑）\nconst purchaseTicket = async () => {\n\tif (isPurchasing.value || isLoading.value) return // 防止重复点击\n\t\n\tisPurchasing.value = true\n\tisLoading.value = true // 显示全屏loading\n\t\n\ttry {\n\t\t// 获取FromSalesId作为salespersonId\n\t\tconst fromSalesId = getFromSalesId()\n\t\t\n\t\tconst orderData = {\n\t\t\toutTradePlatform: 'wechat_applet',\n\t\t\tamountPaid: new Decimal(totalPrice.value).mul(100).toNumber(),\n\t\t\torderSku: [{\n\t\t\t\tticketId: ticketDetail.value.id,\n\t\t\t\tquantity: quantity.value,\n\t\t\t}]\n\t\t}\n\t\t\n\t\t// 如果有FromSalesId，则添加salespersonId\n\t\tif (fromSalesId) {\n\t\t\torderData.salespersonId = fromSalesId\n\t\t}\n\t\t\n\t\tconst result = await orderAPI.create(orderData)\n\n\t\tconst { nonceStr, prepayId, signType, paySign, timeStamp } = result\n\t\tuni.requestPayment({\n\t\t\tprovider:'wxpay',\n\t\t\ttimeStamp,\n\t\t\tnonceStr,\n\t\t\tpackage:`prepay_id=${prepayId}`,\n\t\t\tsignType: signType,\n\t\t\tpaySign: paySign,\n\t\t\tsuccess(responseData) {\n\t\t\t\tisPurchasing.value = false\n\t\t\t\tisLoading.value = false\n\t\t\t\t\n\t\t\t\tif(responseData.errMsg === 'requestPayment:ok'){\n\t\t\t\t\tuni.showToast({\n\t\t\t\t\t\ttitle: '支付成功！',\n\t\t\t\t\t\ticon: 'success',\n\t\t\t\t\t\tduration: 2000\n\t\t\t\t\t})\n\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\tuni.navigateTo({\n\t\t\t\t\t\t\turl:`/pages/ECommerce/pages/order-list?tradeStatus=40`\n\t\t\t\t\t\t})\n\t\t\t\t\t}, 2000)\n\t\t\t\t}else{\n\t\t\t\t\tuni.showToast({\n\t\t\t\t\t\ttitle: '支付取消',\n\t\t\t\t\t\ticon: 'none',\n\t\t\t\t\t\tduration: 2000\n\t\t\t\t\t})\n\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\tuni.navigateTo({\n\t\t\t\t\t\t\turl:`/pages/ECommerce/pages/order-list?tradeStatus=10`\n\t\t\t\t\t\t})\n\t\t\t\t\t}, 2000)\n\t\t\t\t}\n\t\t\t},\n\t\t\tfail(error) {\n\t\t\t\tisPurchasing.value = false\n\t\t\t\tisLoading.value = false\n\t\t\t\t\n\t\t\t\tuni.showToast({\n\t\t\t\t\ttitle: '支付失败',\n\t\t\t\t\ticon: 'error',\n\t\t\t\t\tduration: 2000\n\t\t\t\t})\n\t\t\t\tsetTimeout(() => {\n\t\t\t\t\tuni.navigateTo({\n\t\t\t\t\t\turl:`/pages/ECommerce/pages/order-list?tradeStatus=10`\n\t\t\t\t\t})\n\t\t\t\t}, 2000)\n\t\t\t}\n\t\t})\n\t} catch (error) {\n\t\tisPurchasing.value = false\n\t\tisLoading.value = false\n\t\t\n\t\tconsole.error('购票失败:', error)\n\t\tuni.showToast({\n\t\t\ttitle: '购票失败，请重试',\n\t\t\ticon: 'error',\n\t\t\tduration: 2000\n\t\t})\n\t}\n}\n</script>\n\n<style scoped>\n.content {\n\tbackground-color: white;\n\tpadding-bottom: 160rpx; /* 为底部操作栏留出空间 */\n}\n\n.ticket-poster {\n\twidth: 100%;\n\tposition: relative;\n\toverflow: hidden;\n}\n\n.poster-image {\n\twidth: 100%;\n}\n\n.ticket-info-section {\n\tpadding: 30rpx;\n\tbackground-color: #fff;\n\tmargin-top: 20rpx;\n\tmargin-bottom: 20rpx;\n}\n\n.ticket-name {\n\tfont-size: 36rpx;\n\tfont-weight: bold;\n\tcolor: #333;\n\tdisplay: block;\n\tmargin-bottom: 20rpx;\n\tline-height: 1.4;\n}\n\n.price-section {\n\tdisplay: flex;\n\talign-items: center;\n\tgap: 15rpx;\n\tmargin-bottom: 30rpx;\n}\n\n.original-price {\n\tfont-size: 28rpx;\n\tcolor: #999;\n\ttext-decoration: line-through;\n}\n\n.current-price {\n\tfont-size: 36rpx;\n\tfont-weight: bold;\n\tcolor: #d4c5a0;\n}\n\n.description-section {\n\tmargin-top: 30rpx;\n}\n\n.section-title {\n\tfont-size: 32rpx;\n\tfont-weight: bold;\n\tcolor: #333;\n\tdisplay: block;\n\tmargin-bottom: 15rpx;\n}\n\n.description-text {\n\tfont-size: 28rpx;\n\tline-height: 1.6;\n\tcolor: #666;\n\tdisplay: block;\n}\n\n/* 底部操作栏 */\n.bottom-action-bar {\n\tposition: fixed;\n\tbottom: 0;\n\tleft: 0;\n\tright: 0;\n\tbackground: linear-gradient(135deg, #2c2c2c 0%, #3a3a3a 100%);\n\tdisplay: flex;\n\talign-items: center;\n\tjustify-content: space-between;\n\tpadding: 30rpx 30rpx env(safe-area-inset-bottom);\n\tbox-shadow: 0 -4rpx 20rpx rgba(0, 0, 0, 0.1);\n\tz-index: 1000;\n}\n\n.quantity-section {\n\tdisplay: flex;\n\talign-items: center;\n\tgap: 20rpx;\n}\n\n.quantity-label {\n\tfont-size: 28rpx;\n\tcolor: #ff8c00;\n}\n\n.quantity-control {\n\tdisplay: flex;\n\talign-items: center;\n\tgap: 20rpx;\n}\n\n.quantity-btn {\n\twidth: 50rpx;\n\theight: 50rpx;\n\tborder-radius: 50%;\n\tbackground-color: rgba(255, 140, 0, 0.2);\n\tborder: 2rpx solid #ff8c00;\n\tdisplay: flex;\n\talign-items: center;\n\tjustify-content: center;\n\ttransition: all 0.3s ease;\n}\n\n.quantity-btn:active {\n\tbackground-color: rgba(255, 140, 0, 0.4);\n\ttransform: scale(0.95);\n}\n\n.btn-text {\n\tfont-weight: bold;\n\tcolor: #ff8c00;\n\tfont-size: 24rpx;\n}\n\n.quantity-text {\n\tfont-size: 28rpx;\n\tfont-weight: bold;\n\tcolor: #ff8c00;\n\tmin-width: 40rpx;\n\ttext-align: center;\n}\n\n.buy-section {\n\tdisplay: flex;\n\talign-items: center;\n\tgap: 30rpx;\n}\n\n.total-price {\n\tdisplay: flex;\n\tflex-direction: column;\n\talign-items: flex-end;\n}\n\n.price-label {\n\tfont-size: 24rpx;\n\tcolor: #ff6b00;\n\tmargin-bottom: 5rpx;\n}\n\n.price-value {\n\tfont-size: 32rpx;\n\tfont-weight: bold;\n\tcolor: #ff8c00;\n}\n\n.buy-button {\n\twidth: 200rpx;\n\theight: 70rpx;\n\tbackground: linear-gradient(135deg, #ff8c00 0%, #ff6b00 100%);\n\tborder-radius: 35rpx;\n\tdisplay: flex;\n\talign-items: center;\n\tjustify-content: center;\n\tbox-shadow: 0 4rpx 15rpx rgba(255, 140, 0, 0.3);\n\ttransition: all 0.3s ease;\n}\n\n.buy-button:active {\n\ttransform: scale(0.98);\n}\n\n.buy-button.loading {\n\topacity: 0.7;\n\tpointer-events: none;\n\tbackground: linear-gradient(135deg, #ff6b00 0%, #e55a00 100%);\n}\n\n.buy-text {\n\tfont-size: 28rpx;\n\tfont-weight: bold;\n\tcolor: #ffffff;\n}\n\n/* 全屏loading遮罩样式 */\n.loading-overlay {\n\tposition: fixed;\n\ttop: 0;\n\tleft: 0;\n\tright: 0;\n\tbottom: 0;\n\tbackground-color: rgba(0, 0, 0, 0.7);\n\tdisplay: flex;\n\talign-items: center;\n\tjustify-content: center;\n\tz-index: 9999;\n}\n\n.loading-content {\n\tdisplay: flex;\n\tflex-direction: column;\n\talign-items: center;\n\tjustify-content: center;\n\twidth: 200rpx;\n\theight: 200rpx;\n\tpadding: 40rpx;\n\tbackground-color: rgba(255, 255, 255, 0.95);\n\tborder-radius: 20rpx;\n\tbox-shadow: 0 8rpx 30rpx rgba(0, 0, 0, 0.3);\n}\n\n.loading-spinner {\n\twidth: 80rpx;\n\theight: 80rpx;\n\tborder: 6rpx solid #f3f3f3;\n\tborder-top: 6rpx solid #d4c5a0;\n\tborder-radius: 50%;\n\tanimation: spin 1s linear infinite;\n\tmargin-bottom: 30rpx;\n}\n\n@keyframes spin {\n\t0% { transform: rotate(0deg); }\n\t100% { transform: rotate(360deg); }\n}\n\n.loading-text {\n\tfont-size: 28rpx;\n\tcolor: #333;\n\tfont-weight: 500;\n\ttext-align: center;\n}\n</style>","import MiniProgramPage from '/Users/wangshuli/workspace/mine/pighand/pighand-AIO/client-applet/pages/ECommerce/pages/ticket-detail.vue'\nwx.createPage(MiniProgramPage)"],"names":["ref","watch","onLoad","ticketAPI","uni","Decimal","getFromSalesId","orderAPI"],"mappings":"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"}