# 页面组件开发指南

## 页面组件结构

### 标准页面模板

```vue
<template>
    <PDataManager
        :handle-query="api.query"
        :handle-find="api.find"
        :handle-delete="api.del"
        :handle-create="api.create"
        :handle-update="api.update">
        
        <!-- 自定义表格操作列 -->
        <template #table-column-operation="{ row }">
            <el-button
                size="small"
                type="primary"
                @click="customAction(row)">
                自定义操作
            </el-button>
        </template>
        
        <!-- 自定义详情页面内容 -->
        <template #detail-float>
            <!-- 额外的详情内容 -->
        </template>
    </PDataManager>
</template>

<script lang="ts" setup>
import { h } from 'vue';
import { api } from '@/api';  // 导入对应的API
import provideForm from '@/common/provideForm';
import { ElTag, ElMessage } from 'element-plus';
import { IconName } from '@icon-park/vue-next';

// 表单配置
const { getDetailOperation, queryTableData } = provideForm([
    // 表单字段配置...
]);

// 自定义方法
const customAction = async (row: any) => {
    // 自定义操作逻辑
};
</script>
```

## 创建新页面的步骤

### 步骤1：确定页面位置和命名

根据功能模块，在相应目录下创建页面文件：

```
src/pages/
├── CMS/              # 内容管理
├── ECommerce/        # 电商相关
├── MKT/              # 营销活动
├── base/             # 基础功能
├── common/           # 通用页面
└── distribution/     # 分销相关
```

**命名规范**：使用PascalCase，如 `ProductManagement.vue`

### 步骤2：创建页面文件

#### 示例：创建商品管理页面

**文件路径**: `src/pages/ECommerce/ProductManagement.vue`

```vue
<template>
    <PDataManager
        :handle-query="product.query"
        :handle-find="product.find"
        :handle-delete="product.del"
        :handle-create="product.create"
        :handle-update="product.update">
        
        <template #table-column-operation="{ row }">
            <el-button
                v-if="row.status === 0"
                size="small"
                type="success"
                :icon="Check"
                @click="enableProduct(row)">
                启用
            </el-button>
            <el-button
                v-if="row.status === 1"
                size="small"
                type="warning"
                :icon="Close"
                @click="disableProduct(row)">
                禁用
            </el-button>
        </template>
    </PDataManager>
</template>

<script lang="ts" setup>
import { h } from 'vue';
import { product } from '@/api';
import provideForm from '@/common/provideForm';
import { Check, Close } from '@icon-park/vue-next';
import { ElTag, ElMessage } from 'element-plus';

const { getDetailOperation, queryTableData } = provideForm([
    {
        label: 'ID',
        prop: 'id',
        isDetail: true,
        isPrimaryKey: true,
        hidden: true
    },
    {
        label: '商品名称',
        prop: 'name',
        isTable: true,
        isDetail: true,
        isSearch: true,
        rules: [
            {
                required: true,
                message: '商品名称必填',
                trigger: 'blur'
            }
        ]
    },
    {
        label: '价格',
        prop: 'price',
        isTable: true,
        isDetail: true,
        domType: 'number',
        suffix: '元',
        rules: [
            {
                required: true,
                message: '价格必填',
                trigger: 'blur'
            }
        ]
    },
    {
        label: '分类',
        prop: 'categoryId',
        isTable: true,
        isDetail: true,
        isSearch: true,
        domType: 'select',
        domData: async () => {
            const result = await product.getCategories();
            return result?.data || [];
        }
    },
    {
        label: '状态',
        prop: 'status',
        isTable: true,
        isSearch: true,
        domType: 'select',
        domData: [
            { label: '禁用', value: 0 },
            { label: '启用', value: 1 }
        ],
        tableFormat: (value) => {
            const type = value === 1 ? 'success' : 'danger';
            const text = value === 1 ? '启用' : '禁用';
            return h(ElTag, { type }, text);
        }
    },
    {
        label: '商品图片',
        prop: 'imageUrl',
        isTable: true,
        isDetail: true,
        domType: 'uploadImage',
        tableType: 'image',
        uploadPath: 'product'
    },
    {
        label: '描述',
        prop: 'description',
        isDetail: true,
        domType: 'editor'
    }
]);

// 启用商品
const enableProduct = async (row: any) => {
    const id = getDetailOperation(row).primaryValue;
    
    try {
        await product.updateStatus(id, 1);
        ElMessage.success('启用成功');
        
        // 刷新表格数据
        await queryTableData(async (params: any) => {
            return await product.query(params);
        });
    } catch (error) {
        console.error('启用失败:', error);
    }
};

// 禁用商品
const disableProduct = async (row: any) => {
    const id = getDetailOperation(row).primaryValue;
    
    try {
        await product.updateStatus(id, 0);
        ElMessage.success('禁用成功');
        
        // 刷新表格数据
        await queryTableData(async (params: any) => {
            return await product.query(params);
        });
    } catch (error) {
        console.error('禁用失败:', error);
    }
};
</script>
```

## 常用页面模式

### 1. 标准CRUD页面

适用于大部分数据管理页面，包含增删改查功能。

```vue
<template>
    <PDataManager
        :handle-query="api.query"
        :handle-find="api.find"
        :handle-delete="api.del"
        :handle-create="api.create"
        :handle-update="api.update">
    </PDataManager>
</template>
```

### 2. 只读展示页面

只展示数据，不提供编辑功能。

```vue
<template>
    <PDataManager
        :handle-query="api.query"
        :handle-find="api.find"
        :is-show-drawer="false">
    </PDataManager>
</template>
```

### 3. 带状态管理的页面

包含状态切换功能的页面。

```vue
<template>
    <PDataManager
        :handle-query="api.query"
        :handle-find="api.find"
        :handle-delete="api.del"
        :handle-create="api.create"
        :handle-update="api.update">
        
        <template #table-column-operation="{ row }">
            <el-button
                v-if="row.status === 0"
                size="small"
                type="success"
                @click="enable(row)">
                启用
            </el-button>
            <el-button
                v-if="row.status === 1"
                size="small"
                type="warning"
                @click="disable(row)">
                禁用
            </el-button>
        </template>
    </PDataManager>
</template>
```

### 4. 自定义表单页面

需要复杂表单布局的页面。

```vue
<template>
    <PDataManager
        :handle-query="api.query"
        :handle-find="api.find"
        :handle-delete="api.del"
        :handle-create="api.create"
        :handle-update="api.update">
        
        <template #detail-float>
            <div class="custom-form-section">
                <h3>额外配置</h3>
                <!-- 自定义表单内容 -->
            </div>
        </template>
    </PDataManager>
</template>
```

## 常用插槽 (Slots)

### 表格相关插槽

```vue
<!-- 自定义操作列 -->
<template #table-column-operation="{ row }">
    <el-button @click="customAction(row)">操作</el-button>
</template>

<!-- 自定义表格列 -->
<template #table-column-[prop]="{ row }">
    <span>{{ formatValue(row.prop) }}</span>
</template>
```

### 搜索相关插槽

```vue
<!-- 自定义搜索项 -->
<template #search-[prop]="{ formModel }">
    <custom-component v-model="formModel.prop" />
</template>
```

### 详情相关插槽

```vue
<!-- 自定义详情项 -->
<template #detail-[prop]="{ formModel }">
    <custom-component v-model="formModel.prop" />
</template>

<!-- 详情页面额外内容 -->
<template #detail-float>
    <div>额外内容</div>
</template>
```

## 常用方法和工具

### 获取操作信息

```typescript
// 获取当前操作的详细信息
const { getDetailOperation, queryTableData } = provideForm([...]);

const handleAction = (row: any) => {
    const { op, primaryKey, primaryValue } = getDetailOperation(row);
    // op: 'create' | 'update'
    // primaryKey: 主键字段名
    // primaryValue: 主键值
};
```

### 刷新表格数据

```typescript
// 刷新表格数据
const refreshData = async () => {
    await queryTableData(async (params: any) => {
        return await api.query(params);
    });
};
```

### 消息提示

```typescript
import { ElMessage, ElMessageBox } from 'element-plus';

// 成功提示
ElMessage.success('操作成功');

// 错误提示
ElMessage.error('操作失败');

// 确认对话框
const confirmAction = async () => {
    try {
        await ElMessageBox.confirm('确定要执行此操作吗？', '提示', {
            confirmButtonText: '确定',
            cancelButtonText: '取消',
            type: 'warning'
        });
        
        // 执行操作
        await api.someAction();
        ElMessage.success('操作成功');
    } catch (error) {
        if (error !== 'cancel') {
            console.error('操作失败:', error);
        }
    }
};
```

## 表格格式化

### 状态标签

```typescript
// 状态格式化
tableFormat: (value) => {
    const statusMap = {
        0: { type: 'danger', text: '禁用' },
        1: { type: 'success', text: '启用' }
    };
    const config = statusMap[value] || { type: 'info', text: '未知' };
    return h(ElTag, { type: config.type }, config.text);
}
```

### 日期格式化

```typescript
// 日期格式化
tableFormat: (value) => {
    if (!value) return '-';
    return new Date(value).toLocaleString('zh-CN');
}
```

### 数值格式化

```typescript
// 金额格式化
tableFormat: (value) => {
    if (value === null || value === undefined) return '-';
    return `¥${Number(value).toFixed(2)}`;
}
```

## 完整示例：用户管理页面

**文件路径**: `src/pages/System/UserManagement.vue`

```vue
<template>
    <PDataManager
        :handle-query="user.query"
        :handle-find="user.find"
        :handle-delete="user.del"
        :handle-create="user.create"
        :handle-update="user.update">
        
        <template #table-column-operation="{ row }">
            <el-button
                v-if="row.status === 1"
                size="small"
                type="warning"
                @click="disableUser(row)">
                禁用
            </el-button>
            <el-button
                v-if="row.status === 0"
                size="small"
                type="success"
                @click="enableUser(row)">
                启用
            </el-button>
            <el-button
                size="small"
                type="primary"
                @click="resetPassword(row)">
                重置密码
            </el-button>
        </template>
    </PDataManager>
</template>

<script lang="ts" setup>
import { h } from 'vue';
import { user } from '@/api';
import provideForm from '@/common/provideForm';
import { ElTag, ElMessage, ElMessageBox } from 'element-plus';

const { getDetailOperation, queryTableData } = provideForm([
    {
        label: 'ID',
        prop: 'id',
        isDetail: true,
        isPrimaryKey: true,
        hidden: true
    },
    {
        label: '用户名',
        prop: 'username',
        isTable: true,
        isDetail: true,
        isSearch: true,
        rules: [{ required: true, message: '用户名必填', trigger: 'blur' }]
    },
    {
        label: '邮箱',
        prop: 'email',
        isTable: true,
        isDetail: true,
        isSearch: true,
        rules: [
            { required: true, message: '邮箱必填', trigger: 'blur' },
            { type: 'email', message: '邮箱格式不正确', trigger: 'blur' }
        ]
    },
    {
        label: '角色',
        prop: 'roleId',
        isTable: true,
        isDetail: true,
        isSearch: true,
        domType: 'select',
        domData: async () => {
            const result = await user.getRoles();
            return result?.data || [];
        }
    },
    {
        label: '状态',
        prop: 'status',
        isTable: true,
        isSearch: true,
        domType: 'select',
        domData: [
            { label: '禁用', value: 0 },
            { label: '启用', value: 1 }
        ],
        tableFormat: (value) => {
            const type = value === 1 ? 'success' : 'danger';
            const text = value === 1 ? '启用' : '禁用';
            return h(ElTag, { type }, text);
        }
    },
    {
        label: '创建时间',
        prop: 'createdAt',
        isTable: true,
        tableFormat: (value) => {
            return value ? new Date(value).toLocaleString('zh-CN') : '-';
        }
    }
]);

// 禁用用户
const disableUser = async (row: any) => {
    const id = getDetailOperation(row).primaryValue;
    
    try {
        await ElMessageBox.confirm('确定要禁用该用户吗？', '提示', {
            confirmButtonText: '确定',
            cancelButtonText: '取消',
            type: 'warning'
        });
        
        await user.updateStatus(id, 0);
        ElMessage.success('禁用成功');
        
        await queryTableData(async (params: any) => {
            return await user.query(params);
        });
    } catch (error) {
        if (error !== 'cancel') {
            console.error('禁用失败:', error);
        }
    }
};

// 启用用户
const enableUser = async (row: any) => {
    const id = getDetailOperation(row).primaryValue;
    
    try {
        await user.updateStatus(id, 1);
        ElMessage.success('启用成功');
        
        await queryTableData(async (params: any) => {
            return await user.query(params);
        });
    } catch (error) {
        console.error('启用失败:', error);
    }
};

// 重置密码
const resetPassword = async (row: any) => {
    const id = getDetailOperation(row).primaryValue;
    
    try {
        await ElMessageBox.confirm('确定要重置该用户的密码吗？', '提示', {
            confirmButtonText: '确定',
            cancelButtonText: '取消',
            type: 'warning'
        });
        
        const result = await user.resetPassword(id);
        ElMessage.success(`密码重置成功，新密码：${result.newPassword}`);
    } catch (error) {
        if (error !== 'cancel') {
            console.error('重置密码失败:', error);
        }
    }
};
</script>
```

## 注意事项

1. **组件导入**: 确保正确导入所需的API、组件和工具函数
2. **错误处理**: 使用try-catch处理异步操作的错误
3. **用户体验**: 提供适当的加载状态和反馈信息
4. **权限控制**: 根据用户权限显示或隐藏操作按钮
5. **数据刷新**: 操作完成后及时刷新表格数据
6. **表单验证**: 为重要字段添加适当的验证规则
7. **响应式设计**: 确保页面在不同设备上正常显示

通过遵循这些指南，可以快速创建出功能完整、用户体验良好的管理页面。