# 表单配置指南 (provideForm)

## 概述

`provideForm` 是项目的核心工具函数，用于统一管理搜索表单、数据表格、详情表单的配置。通过声明式的配置方式，可以快速生成完整的CRUD界面。

## 基本用法

```typescript
import provideForm from '@/common/provideForm';

const { getDetailOperation, queryTableData } = provideForm([
    {
        label: '字段名称',
        prop: 'fieldName',
        isTable: true,
        isDetail: true,
        isSearch: true
    }
    // 更多字段配置...
]);
```

## 字段配置详解

### 基础属性

```typescript
{
    label: '用户名',           // 字段显示标签
    prop: 'username',         // 字段属性名
    suffix: '个',             // 字段后缀
    help: '用户名说明',        // 帮助信息
    isPrimaryKey: true,       // 是否为主键
    hidden: false            // 是否隐藏
}
```

### 默认值配置

```typescript
{
    label: '状态',
    prop: 'status',
    default: 1,              // 通用默认值
    searchDefault: 0,        // 搜索表单默认值
    detailDefault: 1         // 详情表单默认值
}
```

### 显示控制

```typescript
{
    label: '创建时间',
    prop: 'createdAt',
    isSearch: true,          // 在搜索表单中显示
    isSearchMore: false,     // 在"更多搜索"中显示
    isTable: true,           // 在数据表格中显示
    isDetail: true,          // 在详情表单中显示
    isCreate: true,          // 在创建表单中显示
    isUpdate: true           // 在更新表单中显示
}
```

### 组件类型配置

#### 输入框 (input)

```typescript
{
    label: '用户名',
    prop: 'username',
    domType: 'input',
    inputType: 'text',       // text | password | textarea
    placeholder: '请输入用户名',
    rules: [
        { required: true, message: '用户名必填', trigger: 'blur' },
        { min: 3, max: 20, message: '长度在3到20个字符', trigger: 'blur' }
    ]
}
```

#### 数字输入框 (number)

```typescript
{
    label: '价格',
    prop: 'price',
    domType: 'number',
    suffix: '元',
    componentProps: {
        min: 0,
        max: 99999,
        precision: 2,
        step: 0.01
    }
}
```

#### 下拉选择 (select)

```typescript
// 静态选项
{
    label: '状态',
    prop: 'status',
    domType: 'select',
    domData: [
        { label: '禁用', value: 0 },
        { label: '启用', value: 1 }
    ]
}

// 动态选项
{
    label: '分类',
    prop: 'categoryId',
    domType: 'select',
    domData: async () => {
        const result = await api.getCategories();
        return result?.data || [];
    }
}

// 带搜索的选项
{
    label: '用户',
    prop: 'userId',
    domType: 'select',
    domData: async (keyword) => {
        const result = await api.searchUsers({ keyword });
        return result?.data || [];
    },
    componentProps: {
        filterable: true,
        remote: true
    }
}
```

#### 复选框 (checkbox)

```typescript
{
    label: '权限',
    prop: 'permissions',
    domType: 'checkbox',
    domData: [
        { label: '读取', value: 'read' },
        { label: '写入', value: 'write' },
        { label: '删除', value: 'delete' }
    ]
}
```

#### 单选框 (radio)

```typescript
{
    label: '性别',
    prop: 'gender',
    domType: 'radio',
    domData: [
        { label: '男', value: 'male' },
        { label: '女', value: 'female' }
    ]
}
```

#### 开关 (switch)

```typescript
{
    label: '是否启用',
    prop: 'enabled',
    domType: 'switch',
    componentProps: {
        activeText: '启用',
        inactiveText: '禁用'
    }
}
```

#### 日期选择器 (datePicker)

```typescript
// 日期选择
{
    label: '出生日期',
    prop: 'birthday',
    domType: 'datePicker',
    componentProps: {
        format: 'YYYY-MM-DD',
        valueFormat: 'YYYY-MM-DD'
    }
}

// 日期时间选择
{
    label: '创建时间',
    prop: 'createdAt',
    domType: 'dateTimePicker',
    componentProps: {
        format: 'YYYY-MM-DD HH:mm:ss',
        valueFormat: 'YYYY-MM-DD HH:mm:ss'
    }
}

// 日期范围选择
{
    label: '时间范围',
    prop: 'dateRange',
    domType: 'datePickerRange',
    componentProps: {
        startPlaceholder: '开始日期',
        endPlaceholder: '结束日期'
    }
}
```

#### 文件上传

```typescript
// 单图片上传
{
    label: '头像',
    prop: 'avatar',
    domType: 'uploadImage',
    uploadPath: 'user/avatar',
    rules: [
        { required: true, message: '头像必填', trigger: 'blur' }
    ]
}

// 多图片上传
{
    label: '商品图片',
    prop: 'images',
    domType: 'uploadImageList',
    uploadPath: 'product/images',
    componentProps: {
        limit: 5,
        multiple: true
    }
}

// 文件上传
{
    label: '附件',
    prop: 'attachment',
    domType: 'uploadFile',
    uploadPath: 'documents',
    uploadAcceptMap: {
        key: 'type',
        map: {
            'pdf': 'application/pdf',
            'doc': 'application/msword',
            'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
        }
    }
}
```

#### 富文本编辑器 (editor)

```typescript
{
    label: '内容',
    prop: 'content',
    domType: 'editor',
    componentProps: {
        height: 300,
        plugins: ['link', 'image', 'table']
    }
}
```

#### 级联选择器 (cascader)

```typescript
{
    label: '地区',
    prop: 'region',
    domType: 'cascader',
    domData: async () => {
        const result = await api.getRegions();
        return result?.data || [];
    },
    componentProps: {
        props: {
            value: 'code',
            label: 'name',
            children: 'children'
        }
    }
}
```

### 表格显示配置

#### 基础表格配置

```typescript
{
    label: '用户名',
    prop: 'username',
    isTable: true,
    tableWidth: 120,         // 列宽
    tableAlign: 'center',    // 对齐方式: left | center | right
    isTableCopyValue: true   // 是否可复制值
}
```

#### 表格类型显示

```typescript
// 图片显示
{
    label: '头像',
    prop: 'avatar',
    isTable: true,
    tableType: 'image'
}

// 链接显示
{
    label: '网站',
    prop: 'website',
    isTable: true,
    tableType: 'link'
}

// 输入框显示（可编辑）
{
    label: '排序',
    prop: 'sort',
    isTable: true,
    tableType: 'input'
}
```

#### 自定义表格格式化

```typescript
import { h } from 'vue';
import { ElTag } from 'element-plus';

// 状态标签格式化
{
    label: '状态',
    prop: 'status',
    isTable: true,
    tableFormat: (value, row, item) => {
        const statusMap = {
            0: { type: 'danger', text: '禁用' },
            1: { type: 'success', text: '启用' }
        };
        const config = statusMap[value] || { type: 'info', text: '未知' };
        return h(ElTag, { type: config.type }, config.text);
    }
}

// 日期格式化
{
    label: '创建时间',
    prop: 'createdAt',
    isTable: true,
    tableFormat: (value) => {
        if (!value) return '-';
        return new Date(value).toLocaleString('zh-CN');
    }
}

// 金额格式化
{
    label: '价格',
    prop: 'price',
    isTable: true,
    tableFormat: (value) => {
        if (value === null || value === undefined) return '-';
        return `¥${Number(value).toFixed(2)}`;
    }
}
```

### 表单验证规则

```typescript
{
    label: '邮箱',
    prop: 'email',
    rules: [
        { required: true, message: '邮箱必填', trigger: 'blur' },
        { type: 'email', message: '邮箱格式不正确', trigger: 'blur' }
    ]
}

{
    label: '手机号',
    prop: 'phone',
    rules: [
        { required: true, message: '手机号必填', trigger: 'blur' },
        { pattern: /^1[3-9]\d{9}$/, message: '手机号格式不正确', trigger: 'blur' }
    ]
}

{
    label: '密码',
    prop: 'password',
    rules: [
        { required: true, message: '密码必填', trigger: 'blur' },
        { min: 6, max: 20, message: '密码长度在6到20个字符', trigger: 'blur' },
        {
            validator: (rule, value, callback) => {
                if (!/(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/.test(value)) {
                    callback(new Error('密码必须包含大小写字母和数字'));
                } else {
                    callback();
                }
            },
            trigger: 'blur'
        }
    ]
}
```

### 分隔符配置

```typescript
// 简单分隔符
{
    label: '基本信息',
    prop: 'divider1',
    divider: true
}

// 带文本的分隔符
{
    label: '高级设置',
    prop: 'divider2',
    divider: '高级设置'
}

// 详细配置的分隔符
{
    label: '其他信息',
    prop: 'divider3',
    divider: {
        content: '其他信息',
        contentPosition: 'left',
        style: 'dashed'
    }
}
```

### 动态表单项

```typescript
{
    label: '扩展字段',
    prop: 'extraField',
    isDetail: (formModel) => {
        // 根据其他字段值决定是否显示
        return formModel.type === 'advanced';
    }
}
```

### 表单联动

```typescript
{
    label: '省份',
    prop: 'provinceId',
    domType: 'select',
    domData: async () => {
        const result = await api.getProvinces();
        return result?.data || [];
    },
    onDetailChange: async (value, formModel) => {
        // 省份改变时，重新加载城市数据
        if (value) {
            const cities = await api.getCities(value);
            // 更新城市选项数据
            updateDomData('cityId', cities?.data || []);
            // 清空城市选择
            formModel.cityId = null;
        }
    }
},
{
    label: '城市',
    prop: 'cityId',
    domType: 'select',
    domData: [] // 初始为空，通过联动加载
}
```

## 完整配置示例

### 用户管理表单配置

```typescript
const { getDetailOperation, queryTableData } = provideForm([
    {
        label: 'ID',
        prop: 'id',
        isPrimaryKey: true,
        hidden: true
    },
    {
        label: '用户名',
        prop: 'username',
        isTable: true,
        isDetail: true,
        isSearch: true,
        tableWidth: 120,
        rules: [
            { required: true, message: '用户名必填', trigger: 'blur' },
            { min: 3, max: 20, message: '长度在3到20个字符', trigger: 'blur' }
        ]
    },
    {
        label: '邮箱',
        prop: 'email',
        isTable: true,
        isDetail: true,
        isSearch: true,
        rules: [
            { required: true, message: '邮箱必填', trigger: 'blur' },
            { type: 'email', message: '邮箱格式不正确', trigger: 'blur' }
        ]
    },
    {
        label: '手机号',
        prop: 'phone',
        isTable: true,
        isDetail: true,
        rules: [
            { required: true, message: '手机号必填', trigger: 'blur' },
            { pattern: /^1[3-9]\d{9}$/, message: '手机号格式不正确', trigger: 'blur' }
        ]
    },
    {
        label: '角色',
        prop: 'roleId',
        isTable: true,
        isDetail: true,
        isSearch: true,
        domType: 'select',
        domData: async () => {
            const result = await api.getRoles();
            return result?.data?.map(item => ({
                label: item.name,
                value: item.id
            })) || [];
        },
        tableFormat: (value, row) => {
            return row.roleName || '-';
        }
    },
    {
        label: '状态',
        prop: 'status',
        isTable: true,
        isDetail: true,
        isSearch: true,
        domType: 'select',
        default: 1,
        domData: [
            { label: '禁用', value: 0 },
            { label: '启用', value: 1 }
        ],
        tableFormat: (value) => {
            const type = value === 1 ? 'success' : 'danger';
            const text = value === 1 ? '启用' : '禁用';
            return h(ElTag, { type }, text);
        }
    },
    {
        label: '头像',
        prop: 'avatar',
        isTable: true,
        isDetail: true,
        domType: 'uploadImage',
        tableType: 'image',
        uploadPath: 'user/avatar'
    },
    {
        label: '个人简介',
        prop: 'bio',
        isDetail: true,
        domType: 'input',
        inputType: 'textarea',
        componentProps: {
            rows: 4,
            maxlength: 500,
            showWordLimit: true
        }
    },
    {
        label: '创建时间',
        prop: 'createdAt',
        isTable: true,
        tableFormat: (value) => {
            return value ? new Date(value).toLocaleString('zh-CN') : '-';
        }
    }
]);
```

### 商品管理表单配置

```typescript
const { getDetailOperation, queryTableData } = provideForm([
    {
        label: 'ID',
        prop: 'id',
        isPrimaryKey: true,
        hidden: true
    },
    {
        label: '商品名称',
        prop: 'name',
        isTable: true,
        isDetail: true,
        isSearch: true,
        rules: [
            { required: true, message: '商品名称必填', trigger: 'blur' }
        ]
    },
    {
        label: '商品编码',
        prop: 'code',
        isTable: true,
        isDetail: true,
        isSearch: true,
        rules: [
            { required: true, message: '商品编码必填', trigger: 'blur' }
        ]
    },
    {
        label: '分类',
        prop: 'categoryId',
        isTable: true,
        isDetail: true,
        isSearch: true,
        domType: 'cascader',
        domData: async () => {
            const result = await api.getCategories();
            return result?.data || [];
        },
        componentProps: {
            props: {
                value: 'id',
                label: 'name',
                children: 'children'
            }
        }
    },
    {
        label: '价格',
        prop: 'price',
        isTable: true,
        isDetail: true,
        domType: 'number',
        suffix: '元',
        rules: [
            { required: true, message: '价格必填', trigger: 'blur' }
        ],
        componentProps: {
            min: 0,
            precision: 2
        },
        tableFormat: (value) => {
            return value ? `¥${Number(value).toFixed(2)}` : '-';
        }
    },
    {
        label: '库存',
        prop: 'stock',
        isTable: true,
        isDetail: true,
        domType: 'number',
        suffix: '件',
        componentProps: {
            min: 0
        }
    },
    {
        label: '商品图片',
        prop: 'images',
        isTable: true,
        isDetail: true,
        domType: 'uploadImageList',
        tableType: 'image',
        uploadPath: 'product/images',
        componentProps: {
            limit: 5
        }
    },
    {
        label: '商品详情',
        prop: 'description',
        isDetail: true,
        domType: 'editor',
        componentProps: {
            height: 300
        }
    },
    {
        label: '是否推荐',
        prop: 'isRecommended',
        isTable: true,
        isDetail: true,
        isSearch: true,
        domType: 'switch',
        default: false,
        tableFormat: (value) => {
            const type = value ? 'success' : 'info';
            const text = value ? '是' : '否';
            return h(ElTag, { type }, text);
        }
    },
    {
        label: '状态',
        prop: 'status',
        isTable: true,
        isDetail: true,
        isSearch: true,
        domType: 'select',
        default: 1,
        domData: [
            { label: '下架', value: 0 },
            { label: '上架', value: 1 },
            { label: '待审核', value: 2 }
        ],
        tableFormat: (value) => {
            const statusMap = {
                0: { type: 'danger', text: '下架' },
                1: { type: 'success', text: '上架' },
                2: { type: 'warning', text: '待审核' }
            };
            const config = statusMap[value] || { type: 'info', text: '未知' };
            return h(ElTag, { type: config.type }, config.text);
        }
    }
]);
```

## 返回值和方法

### getDetailOperation

获取当前操作的详细信息：

```typescript
const handleAction = (row: any) => {
    const { op, primaryKey, primaryValue } = getDetailOperation(row);
    // op: 'create' | 'update'
    // primaryKey: 主键字段名
    // primaryValue: 主键值
    
    console.log(`操作类型: ${op}, 主键: ${primaryKey}=${primaryValue}`);
};
```

### queryTableData

刷新表格数据：

```typescript
const refreshData = async () => {
    await queryTableData(async (params: any) => {
        return await api.query(params);
    });
};
```

### 其他返回值

```typescript
const {
    formColumns,           // 表单列配置
    formRules,            // 表单验证规则
    tableDataModel,       // 表格数据模型
    searchFormModel,      // 搜索表单数据
    detailFormModel,      // 详情表单数据
    isTableDataLoading,   // 表格加载状态
    isDetailDataLoading,  // 详情加载状态
    isOpenDetail,         // 详情抽屉开启状态
    pageSize,             // 分页大小
    pageNumber,           // 当前页码
    domDataSet,           // 组件数据集
    getDomData,           // 获取组件数据方法
    watchDetailForm       // 监听详情表单变化
} = provideForm([...]);
```

## 最佳实践

### 1. 字段复用

```typescript
// 定义通用字段配置
const commonFields = {
    id: {
        label: 'ID',
        prop: 'id',
        isPrimaryKey: true,
        hidden: true
    },
    status: {
        label: '状态',
        prop: 'status',
        isTable: true,
        isDetail: true,
        isSearch: true,
        domType: 'select',
        domData: [
            { label: '禁用', value: 0 },
            { label: '启用', value: 1 }
        ],
        tableFormat: (value) => {
            const type = value === 1 ? 'success' : 'danger';
            const text = value === 1 ? '启用' : '禁用';
            return h(ElTag, { type }, text);
        }
    }
};

// 使用通用字段
const { } = provideForm([
    commonFields.id,
    commonFields.status,
    // 其他特定字段...
]);
```

### 2. 条件显示

```typescript
{
    label: '高级选项',
    prop: 'advancedOption',
    isDetail: (formModel) => {
        return formModel.type === 'advanced';
    }
}
```

### 3. 数据缓存

```typescript
// 缓存选项数据
let categoryCache = null;

{
    label: '分类',
    prop: 'categoryId',
    domType: 'select',
    domData: async () => {
        if (!categoryCache) {
            const result = await api.getCategories();
            categoryCache = result?.data || [];
        }
        return categoryCache;
    }
}
```

### 4. 错误处理

```typescript
{
    label: '分类',
    prop: 'categoryId',
    domType: 'select',
    domData: async () => {
        try {
            const result = await api.getCategories();
            return result?.data || [];
        } catch (error) {
            console.error('加载分类失败:', error);
            return [];
        }
    }
}
```

## 注意事项

1. **性能优化**: 对于大量数据的选项，考虑使用分页或搜索
2. **数据格式**: 确保API返回的数据格式与配置匹配
3. **验证规则**: 合理设置验证规则，提供良好的用户体验
4. **默认值**: 为重要字段设置合理的默认值
5. **错误处理**: 为异步数据加载添加错误处理
6. **类型安全**: 在TypeScript项目中，为配置对象定义正确的类型

通过合理使用 `provideForm`，可以大大简化表单开发工作，提高开发效率和代码质量。